# 简介

 filecoin是运行在ipfs上的激励层，ipfs自身是一个p2p形式的传输协议。其具有p2p网络的典型特点， 优势在于去中心化，拓展性强，快速，安全。 但是缺点也同样：数据冗余，无法确保数据必然存在，也无法保证数据的服务效率。filecoin的目的就在于解决这个问题，其致力于建立一个完善的去中心化的存储市场，通过发行数字货币FIL吸引矿工参与数据存储，通过复制证明和时空证明确保数据的唯一性和存在性。其存储服务是中心化的，但是整个市场是完全去中心化的，filecoin还提供了一套交易系统来方便用户与数据服务商做交易，主要包括存储和检索是双向的数据流和资金流。

# 链

filecoin 链整体设计和一般区块链并没有什么不同，包括区块管理，消息池，p2p网络协议，vm消息运算，私钥管理，jsonrpc接口服务。但是在具体的机制设计上确是极具特色的，无论在实现上还是机制上都十分具有参考价值。

* 聚合区块: filecoin整体上依然是个链式结构，只是传统区块的概念这里用Tipset替换，每个Tipset里面包含多个区块，每个区块都是平等的，有相同的执行权和获取收益的权利。但是这种方式并不能提高整体的tps，因为Tipset里面的区块仍然是在同一个账本上同意记录

* 分布式随机数：早期filecoin的随机数也采用的锚定自身过去的某一个高度的记录的hash随机值，后来采用了beacon分布式随机数系统。 beacon是一个随着时间推进，基于聚合签名的确定性的数值产生算法。优点是随机数更加具有不确定性，确定时依赖了另外的一个三方系统，一旦beacon服务器的私钥泄露会产生及其严重的后果。

* 锚定时间戳：像比特币，以太坊这样的链都是通过难度调整来控制区块产生间隔，这样的结果是长时间来看区块间隔是符合设计预期，但是来看就可能偏多或者偏少。。 filecoin则在共识中通过时间戳校验和随即数发生器严格限制了区块的产生间隔。原因在于filecoin挖矿的目的并不在于保证链的稳定性，而是在于基于存储而做服务。竞争性挖矿不利于filecoin提供稳定的服务。

* 帐号系统：filecoin地址设计中分为三种地址f0,f1,f3 .f0是合约地址，f1是传统的secp加密算法，f3是支持聚合签名的bls签名算法。 其中每个f1, f3及矿工地址f0都对应一个f0的合约地址。filecoin中合约都是内置的函数，并没有类似以太坊的脚本引擎。目前的系统合约有
    1. init: 用于初始化其他合约
    2. cron：用于系统中的调度触发。每次tipset计算完毕之后触发该函数用，用于做provecommit的批量处理， 奖励，power的一些数值统计， sector的分配等
    3. accoount： 帐号合约，目前仅有获取公钥的函数
    4. market： 用于存储市场，用于用户和矿工的订单抵押，以及在维持订单数据期间，自动将用户抵押的fil随着高度地推移线性的支付给矿工。
    5. miner：用于矿工相关数据的存储，包括sector证明阶段信息，sector的分布，抵押的金额等。
    6. multisig：多签合约
    7. paych:类似闪电网络的合约，用于线下支付，目前用于检索数据时分阶段的支付fil，这样可以减少手续费用。
    8. power：保存全网算力及矿工的算力信息
    9. reward：区块奖励计算函数
    10. system：系统调用的函数，禁止外部调用
    11. verifreg：验证节点信息，用于deal数据的验证使之具有更高的算力权重

* 聚合签名： bls支持聚合签名，优势在于可以将区块里面多个bls类型的消息签名聚合在一起，这样就减少了消息检验产生的消耗了。

* 惩罚措施： 相对于很多区块链仍旧停留在纸面上的惩罚手段，filecoin已经具备完善的惩罚手段。 
    1. 通过共识惩罚来防止矿工不按规则出快，例如在同一个高度出两个快，防止了双挖。
    2. 证明时主动申报数据暂时不可服务
    3. 数据发生不可恢复错误时，终止服务。
    4. 时空证明不能即时提交
其中时空证明惩罚最为诟病，由于矿工特别是小矿工难以保证消息上链，这种情况下产生的惩罚就有几分无辜。即便是大矿工也无法百分百保证，区块链这种去中心化的系统，目前的体系下只能尽量的减少被惩罚的可能。

* 复制证明：复制证明包括两个阶段preseal和seal。preseal阶段目的在于将元数据进行编码，为了防止女巫攻击，这里选择了一种单核无法并发的dag算法，通过大量的单向运算来保证安全时间。seal阶段用于产生复制证明，目的在于确保矿工确实运行了preseal的数据变换，因而零知识证明的电路设计就是从preseal产生的结果集中采样一部分数据出来运算电路产生一个证明。

* 时空证明：时空证明Post的目的在于保证矿工不会增长算力后有删除数据，只有证明数据的持续存在，矿工才能为用户提供服务，生态才能健康发展。时空证明将复制证明而阶段产生的编码文件及初始参数作为输入来计算证明。Post包含两个部分，分别时出块时的挑战和定时的WindowsPost证明，前者用于随机抽查，后者用于全量覆盖两者电路基本相同只是采样数量有所区别。WindowsPost实现上将每天分成若干时间片。每个时间片包含若干个固定数量的扇区集合。只要在时间片结束前提交每个扇区集合的证明就算是通过
# 市场

存储检索市场实现在单独的项目里面，其主要作用在于维护存储和检索时候的数据流和资金流.

* 存储（数据传输， 抵押）
* 检索 (数据传输，逐块结算)
